---
output:
  word_document:
    reference_docx: word_template.docx
author: "GH/OHA/SPS/HWF"
geometry: margin = 2cm
date: "`r format(Sys.time(), '%d %B, %Y')`"

params: 
    set_title: "My Title!"
    operating_unit: !r c("Tanzania")
    fiscal_year: "FY24"
---

---
title: "`r params$fiscal_year` Human Resources for Health (HRH) Inventory Summary - `r params$operating_unit`"
---


```{r setup, include=FALSE}

# set global standards
knitr::opts_chunk$set(echo = FALSE) # supress code outputs
knitr::opts_chunk$set(warning = FALSE, message = FALSE) # suppress all warnings
knitr::opts_chunk$set(dpi=300) # set high resolution of plots

# load all needed libraries
library(plyr)
library(dplyr)
library(tidyverse)
library(sqldf)
library(janitor)
library(readxl)
library(writexl)
library(shiny)
library(scales)
library(tidyquant)
library(formattable)
library(kableExtra)
library(ggrepel)
library(ggplot2)
library(patchwork)


```

## Background

This HRH Inventory Briefer provides a detailed summary of the FY24 HRH Inventory for Tanzania. This report summarizes data gathered through the HRH inventory templates submitted by prime implementation partners. This report is meant to help Mission teams better monitor and understand their PEPFAR-supported staffing footprint. Missions should use these briefers to review their staffing investments and trends at the OU level to inform programming and facilitate HRH planning in line with COP guidance, including for the long-term sustainability of the HIV response. If there are questions on the summary info provided here, please reach out to the HRH Reporting Helpdesk (hrh-reporting-helpdesk@usaid.gov). Additional data and visualizations can be provided upon request. 

```{r}

# Load the FSD, HRH, and merged FSD-HRH dataset
fin_data_orig <- read.delim("./1. Data/Financial_Structured_Datasets_COP17-24_20241213.txt") # read in FSD dataset
load(file = "./4. Outputs/RDS/FY24_cleanHRH.rds") # cleaned HRH dataset
load(file = "./4. Outputs/RDS/HRH_ER_merged_21_24.rds") # HRH-ER merged dataset


```

## `r params$fiscal_year` HRH Inventory Completeness and Data Quality

Table 1 shows the number of mechanisms and their associated staffing expenditure in `params$operating_unit` that submitted both the Expenditure Reporting (ER) and HRH Inventory templates for `r params$fiscal_year`. This information provides for better understanding of the overall completeness of the HRH inventory in terms of the number of mechanisms that were submitted, and the total dollar value that was reported to HRH compared to ER.

The total staffing expenditure reported in HRH and ER by USAID, CDC, and other agencies should closely match each other. However, the reported HRH and ER staffing expenditures will not always exactly match each other because ER staffing expenditures reported under ‘Other Contracts’ or ‘Contracted Interventions’ cost categories cannot be fully disaggregated. HRH and ER reporting from each implementing partner should have worked together to ensure alignment of reported staffing expenditures. 

```{r, echo = FALSE, eval = TRUE}

# Create summary df to be used for table output
mech_submissions <- finalMerge %>%
  filter(year == 2024) %>%
  filter(UN_keywordflags == "FALSE") %>% # excluding all GHSC and UN mechanisms
  filter(operating_unit == params$operating_unit) %>%
  group_by(year, operating_unit, funding_agency, mech_code) %>%
  summarise(HRH_expenditure_amt = sum(HRH_expenditure_amt, na.rm = T), 
            ER_expenditure_amt = sum(ER_expenditure_amt[HRH_relevant == "Y"], na.rm = T)) %>%
  ungroup() %>%
  group_by(funding_agency) %>%
  summarise(Num_HRH_submissions = length(mech_code[HRH_expenditure_amt > 0]),
            Num_ER_submissions = length(mech_code[ER_expenditure_amt > 0]),
            HRH_expenditure_amt = sum(HRH_expenditure_amt, na.rm = T),
            ER_expenditure_amt = sum(ER_expenditure_amt, na.rm = T)) %>%
  ungroup() %>%
  arrange(desc(HRH_expenditure_amt)) %>%
  adorn_totals() %>%
  mutate(pct_submission_rate = HRH_expenditure_amt / ER_expenditure_amt) %>%
  mutate(funding_agency = if_else(funding_agency == "Total", "PEPFAR", funding_agency)) %>%
  arrange(desc(HRH_expenditure_amt)) %>%
  
  # format the columns
  mutate(across(4:5, formattable::currency,digits=0)) %>%
  mutate(across(6, formattable::percent, digits=0))

# Now display the final table with formatted column names
knitr::kable(mech_submissions, "simple", 
             col.names=c("Funding Agency", "No. of HRH Submissions", "No. of ER Submissions", 
                         "HRH Expenditure Amount (USD)", "ER Expenditure Amount   (USD)", "HRH Expenditure as % of ER Expenditure"),
             caption = "Table I: Submission Rate by Agency")


```

## `r params$fiscal_year` PEPFAR Staffing Footprint

Table 1 shows the number of mechanisms and their associated staffing expenditure in `r params$operating_unit` that submitted both the Expenditure Reporting (ER) and HRH Inventory templates this year. This information provides for better understanding of the overall completeness of the HRH inventory in terms of the number of mechanisms that were submitted, and the total dollar value that was reported to HRH compared to ER.

The total staffing expenditure reported in HRH and ER by USAID, CDC, and other agencies should closely match each other. However, the reported HRH and ER staffing expenditures will not always exactly match each other because ER staffing expenditures reported under ‘Other Contracts’ or ‘Contracted Interventions’ cost categories cannot be fully disaggregated. HRH and ER reporting from each implementing partner should have worked together to ensure alignment of reported staffing expenditures. 

```{r echo = FALSE, eval = TRUE}

# Create the first df that summarizes PEPFAR
infographic_PEPFAR <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(operating_unit == params$operating_unit) %>%
  mutate(funding_agency = "PEPFAR") %>%
  group_by(funding_agency) %>%
  summarise(HRH_expenditure = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T),
            annual_fte = sum(annual_fte, na.rm = T),
            placeholder_pctHRH = sum(actual_annual_spend, na.rm = T))

# Calculate the % spent towards staffing
PEPFAR_pct_HRH <- finalMerge %>%
  filter(year == 2024) %>%
  filter(operating_unit == params$operating_unit) %>%
  group_by(year, operating_unit) %>%
  summarise(HRH_expenditure_amt = sum(HRH_expenditure_amt, na.rm = T),
            ER_expenditure_amt = sum(ER_expenditure_amt, na.rm = T)) %>%
  ungroup() %>%
  mutate(PEPFAR_pct_HRH = HRH_expenditure_amt / ER_expenditure_amt) %>%
  pull(PEPFAR_pct_HRH)

# Replace the % HRH placeholder value with the calculated value
infographic_PEPFAR <- infographic_PEPFAR %>%
  mutate(placeholder_pctHRH = PEPFAR_pct_HRH) %>%
  rename(pct_HRH = placeholder_pctHRH)

# Now, create the second df that summarizes the individual funding agencies
infographic_USAID <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(operating_unit == params$operating_unit) %>%
  mutate(funding_agency = if_else(funding_agency != "USAID" & funding_agency != "CDC", "Other", funding_agency)) %>%
  group_by(funding_agency) %>%
  summarise(HRH_expenditure = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T),
            annual_fte = sum(annual_fte, na.rm = T),
            placeholder_pctHRH = sum(actual_annual_spend, na.rm = T))

# Calculate the % spent towards staffing for the individual funding agencies
USAID_pct_HRH <- finalMerge %>%
  filter(year == 2024) %>%
  filter(operating_unit == params$operating_unit) %>%
  group_by(year, operating_unit, funding_agency) %>%
  summarise(HRH_expenditure_amt = sum(HRH_expenditure_amt, na.rm = T),
            ER_expenditure_amt = sum(ER_expenditure_amt, na.rm = T)) %>%
  ungroup() %>%
  mutate(pct_HRH = HRH_expenditure_amt / ER_expenditure_amt) %>%
  select(funding_agency, pct_HRH)

# Replace the % HRH placeholder value with the calculated values
infographic_USAID <- left_join(infographic_USAID, USAID_pct_HRH, by = "funding_agency") %>%
  select(-placeholder_pctHRH)

# Lastly, bind both data frames together to create the final summary table
infographic <- rbind(infographic_PEPFAR, infographic_USAID) %>%
  arrange(desc(HRH_expenditure)) %>%

# format the columns
  mutate(across(2, formattable::currency, digits=0)) %>%
  mutate(across(3:4, formattable::accounting, digits=0)) %>%
  mutate(across(5, formattable::percent, digits=0))

# Display the final summary table with formatted column names
knitr::kable(infographic, "simple", 
             col.names=c("Funding Agency", "HRH Staffing Expenditure", "Individual Count", 
                         "Total FTE (Full-Time Equivalence)", "% of Total Expenditures Spent Towards HRH"),
             caption = "Table 2: USAID’s HRH Investments as a Proportion of PEPFAR’s HRH Investments")

# EDIT: Calculate the % of PEPFAR HRH expenditures channeled through USAID vs CDC for in-line text
PEPFAR_HRH_expenditure <- infographic_PEPFAR %>%
  pull(HRH_expenditure)

pct_USAID <- infographic %>%
  select(funding_agency, HRH_expenditure, individual_count) %>%
  filter(funding_agency == "USAID") %>%
  mutate(pct_HRH = HRH_expenditure / PEPFAR_HRH_expenditure) %>%
  mutate(across(4, formattable::percent, digits=0)) %>%
  pull(pct_HRH)

pct_CDC <- infographic %>%
  select(funding_agency, HRH_expenditure, individual_count) %>%
  filter(funding_agency == "CDC") %>%
  mutate(pct_HRH = HRH_expenditure / PEPFAR_HRH_expenditure) %>%
  mutate(across(4, formattable::percent, digits=0)) %>%
  pull(pct_HRH)

```

Overall, about `r pct_USAID` of PEPFAR's HRH expenditures are channeled through USAID while `r pct_CDC` of PEPFAR's HRH expenditures are channeled through CDC.

\pagebreak

## `r params$fiscal_year` Staffing by Funding Agency

Figure 1 provides a summary of the total staffing expenditure and total headcount supported by each PEPFAR implementing agency (USAID, CDC, and Other) for implementation of FY24 program activities.

```{r fig1, fig.height = 6, fig.width = 10, echo = FALSE, eval = TRUE}

# First, create a df that shows HRH expenditure and individual count by agency
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, funding_agency, actual_annual_spend, individual_count) %>%
  group_by(funding_agency) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(individual_count)) 

# Make the first plot
g1 <- ggplot(data = patchwork, mapping = aes(x = reorder(funding_agency, -actual_annual_spend), y = individual_count, fill = funding_agency)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  scale_fill_manual(values = c("CDC" = "#f2bc40", 
                              "USAID" = "#c43d4d", 
                              "Other agencies" = "#808080")) +
  
    geom_label(
        aes(y     = individual_count,
            label = scales::comma(round(individual_count))),
        size = 5
    ) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("Individual Count")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 15),
        text = element_text(size = 18)) 
  
# Make the second plot 

g2 <- ggplot(data = patchwork, mapping = aes(x = reorder(funding_agency, -actual_annual_spend), y = actual_annual_spend, fill = funding_agency)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  scale_fill_manual(values = c("CDC" = "#f2bc40", 
                              "USAID" = "#c43d4d", 
                              "Other agencies" = "#808080")) +
  
      geom_label(
        aes(y     = actual_annual_spend,
            label = scales::dollar(round(actual_annual_spend))),
        size = 5
    ) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("HRH Expenditure")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 15),
        text = element_text(size = 18)) 
   
g3 <- g2 + g1 + plot_annotation('Figure 1: HRH Expenditure and Individual Count by PEPFAR Funding Agency', theme=theme(plot.title=element_text(size=15)))

g3


```

\pagebreak

## `r params$fiscal_year` Top USAID Prime Implementation Partners 

Figure 2 shows the top five prime partners with the highest HRH expenditure for USAID in `r params$operating_unit`. Each prime partner is disaggregated by primary program area to indicate the program activities that each partner is engaged in. Additional partner-level or mechanism-level deep dives can be provided upon request.

```{r fig10, fig.height = 6, fig.width = 10, echo = FALSE, eval = TRUE}

# Pull names of top 5 partners only
top_5_partners <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  group_by(prime_partner_name) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T)) %>%
  arrange(desc(actual_annual_spend)) %>%
  top_n(n = 5, wt = actual_annual_spend) %>%
  pull(prime_partner_name)

# Create a summary table that filters for the top 5 partner names only
prime_partners <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  filter(prime_partner_name %in% top_5_partners) %>%
  select(fiscal_year, er_category, prime_partner_name, actual_annual_spend) %>%
  group_by(prime_partner_name, er_category) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T)) %>%
  arrange(desc(actual_annual_spend)) %>%
  mutate(prime_partner_name_wrapped = str_wrap(prime_partner_name, width = 10))
  
# Now make the plot
  ggplot(prime_partners, aes(x = reorder(prime_partner_name_wrapped, -actual_annual_spend), 
                             y = actual_annual_spend, 
                             fill = er_category,
                             label = actual_annual_spend)) +
  
  geom_bar(stat = "identity", width = 0.7) +
    
  geom_label_repel(data = prime_partners, aes(label=scales::dollar(round(actual_annual_spend))),
             size = 3,
             position = position_stack(vjust = 0.5),
             min.segment.length = 0.25,
          #   direction = "x",
             show.legend = FALSE) +
 
  scale_y_continuous(labels = label_dollar()) +
    
  ggtitle("Figure 2: Top Five Prime Implementing Partners by HRH Expenditure") +
    
  xlab("Prime Partner Name") +
    
  ylab("HRH Expenditure") + 
    
  labs(fill = "Worker Type (ER Category)") +
  
  scale_fill_manual(values = c("HCW: Ancillary" = "#287c6f", 
                              "HCW: Clinical" =  "#2057a7", 
                              "Other Staff" = "#808080", 
                              "Program Management" = "#C43d4d")) +
    
  theme_tq() +
  
  theme(plot.title = element_text(size = 10),
        text = element_text(size = 10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 

```

\pagebreak

## Primary Program Areas
Figure 3 shows total HRH expenditure and the number of individual staff by primary program area for USAID. Note that the HRH inventory collects data on ‘primary’ program area; staff can only be categorized in the one program area that accounts for most of their time. While staff typically work on multiple program areas, only the primary program area is reported at this time.

It is not uncommon to see higher staffing expenditures for Program Management (PM) and Above Service Programming (ASP) and lower expenditures for Prevention (PREV), Socioeconomic (SE), or HIV Testing (HTS) program areas. A number of factors may contribute to the level and ranking of HRH expenditure for program areas. Ranking may be impacted by various factors including higher costs for technical experts, higher volume for specific cadres, or local vs international partner costs.

```{r fig2, fig.height = 6, fig.width = 10, echo = FALSE, eval = TRUE}

# Create a df that shows HRH expenditure and individual count by program area
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, funding_agency, program, actual_annual_spend, individual_count) %>%
  group_by(program) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(individual_count)) 

# Create % of total table for inline text later
patchwork_pct_PM <- patchwork %>%
  adorn_percentages("col") %>%
  mutate(actual_annual_spend = round(actual_annual_spend * 100),
         individual_count = round(individual_count * 100)) %>%
  filter(program == "PM") %>%
  pull(actual_annual_spend)

# Make the first plot

g1 <- ggplot(data = patchwork, mapping = aes(x = reorder(program, -actual_annual_spend), y = individual_count, fill = program)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("PM" = "#c43d4d", 
                              "ASP" = "#e07653", 
                              "C&T" = "#2057a7",
                              "SE" = "#1e87a5",
                              "HTS" = "#8980cb",
                              "PREV" = "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::comma(round(individual_count))),
             size = 5,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("Individual Count by Program Area")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 15),
        text = element_text(size = 18)) 

# Make the second plot

g2 <- ggplot(data = patchwork, mapping = aes(x = reorder(program, -actual_annual_spend), y = actual_annual_spend, fill = program)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("PM" = "#c43d4d", 
                              "ASP" = "#e07653", 
                              "C&T" = "#2057a7",
                              "SE" = "#1e87a5",
                              "HTS" = "#8980cb",
                              "PREV" = "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::dollar(round(actual_annual_spend))),
             size = 5,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("HRH Expenditure by Program Area")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 15),
        text = element_text(size = 18)) 
   
g3 <- g2 + g1

g3

```
Key: PM = Program Management, ASP = Above Site Programming, C&T = Care and Treatment, SE = Socioeconomic, HTS = HIV Testing Services, PREV = Prevention

\pagebreak

## Top Employment Titles Based on Individual Count
Figure 4 shows the top five employment titles supported by PEPFAR USAID based on individual count. The total expenditure for each title is also provided. Across PEPFAR-supported countries, the employment titles with the highest staff count are typically community-based staff providing direct service delivery.

```{r fig3, fig.height = 4, fig.width = 7, echo = FALSE, eval = TRUE}

# Create a df that shows individual count by the top 10 employment title
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, funding_agency, employment_title, actual_annual_spend, individual_count) %>%
  group_by(employment_title) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(individual_count)) %>%
  top_n(n = 5, wt = individual_count) %>%
  ungroup() %>%
  mutate(employment_title_wrapped = str_wrap(employment_title, width = 10)) %>%
  select(-employment_title)

# Make the first plot
g1 <- ggplot(data = patchwork, mapping = aes(x = reorder(employment_title_wrapped, -actual_annual_spend), y = individual_count, fill = employment_title_wrapped)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("#c43d4d", 
                              "#e07653", 
                              "#2057a7",
                              "#1e87a5",
                              "#8980cb",
                              "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::comma(round(individual_count))),
             size = 3,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("Individual Count")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 

# Make the second plot

g2 <- ggplot(data = patchwork, mapping = aes(x = reorder(employment_title_wrapped, -actual_annual_spend), y = actual_annual_spend, fill = employment_title_wrapped)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("#c43d4d", 
                              "#e07653", 
                              "#2057a7",
                              "#1e87a5",
                              "#8980cb",
                              "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::dollar(round(actual_annual_spend))),
             size = 3,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("HRH Expenditure")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 
   
g3 <- g2 + g1 + plot_annotation('Figure 4: Top Employment Titles by Individual Count (along with their HRH expenditure)', theme=theme(plot.title=element_text(size=10)))

g3

```

## Top Employment Titles Based on HRH Expenditure
Figure 5 shows the top five employment titles supported by PEPFAR USAID based on HRH expenditure. Counts for each are also provided. Across PEPFAR-supported countries, employment titles with the highest HRH expenditure are typically above site, non-service delivery staff.

```{r fig4, fig.height = 4, fig.width = 7, echo = FALSE, eval = TRUE}

# Create a df that shows HRH expenditure by the top 5 employment title
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, funding_agency, employment_title, actual_annual_spend, individual_count) %>%
  group_by(employment_title) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(actual_annual_spend)) %>%
  top_n(n = 5, wt = actual_annual_spend) %>% # filter for the top 5
  ungroup() %>%
  mutate(employment_title_wrapped = str_wrap(employment_title, width = 10)) %>%
  select(-employment_title)

# Make the first plot
g1 <- ggplot(data = patchwork, mapping = aes(x = reorder(employment_title_wrapped, -actual_annual_spend), y = individual_count, fill = employment_title_wrapped)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("#c43d4d", 
                              "#e07653", 
                              "#2057a7",
                              "#1e87a5",
                              "#8980cb",
                              "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::comma(round(individual_count))),
             size = 3,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("Individual Count")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 

# Make the second plot

g2 <- ggplot(data = patchwork, mapping = aes(x = reorder(employment_title_wrapped, -actual_annual_spend), y = actual_annual_spend, fill = employment_title_wrapped)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("#c43d4d", 
                              "#e07653", 
                              "#2057a7",
                              "#1e87a5",
                              "#8980cb",
                              "#808080")) +
  
        geom_label_repel(data = patchwork, aes(label = scales::dollar(round(actual_annual_spend))),
             size = 3,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("HRH Expenditure")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 10),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 
   
g3 <- g2 + g1 + plot_annotation('Figure 5: Top Employment Titles by HRH Expenditure (along with their Individual Count)', theme=theme(plot.title=element_text(size=10)))


g3

```

\pagebreak

## `r params$fiscal_year` Median Annual Remuneration
Figure 6 presents a scatter plot that shows the median annual remuneration (i.e. based on estimated annual salary) of the top 10 employment titles across all USAID Implementing Partners. Each dot represents an individual’s estimated annual remuneration, and the black line represents the median annual remuneration for the employment title. The density of the dots reflects the number of individuals contributing to the median, and the range can be interpreted via the spread of the individual dots.

```{r fig5, fig.height = 8, fig.width = 10, echo = FALSE, eval = TRUE}

# Prepare the remuneration df to be used
remuneration <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  select(employment_title, equivalent_annual_salary)

# Remove any extreme outliers, since we do not want to visualize them in our box plot
detect_outlier <- function(x) {
  # calculate first quantile
  Quantile1 <- quantile(x, probs=.01)
  # calculate third quantile
  Quantile3 <- quantile(x, probs=.98)
  # calculate inter quartile range
  IQR = Quantile3-Quantile1
  # return true or false
  x > Quantile3 + (IQR*1.5) | x < Quantile1 - (IQR*1.5)
}
 
# create remove outlier function
remove_outlier <- function(dataframe,
                            columns=names(dataframe)) {
  # for loop to traverse in columns vector
  for (col in columns) {
    # remove observation if it satisfies outlier function
    dataframe <- dataframe[!detect_outlier(dataframe[[col]]), ]
  }
  
  return(dataframe)
}

# Now use the function to remove extreme outliers from our remuneration df
remuneration <- remove_outlier(remuneration, 'equivalent_annual_salary')

# Calculate the median annual remuneration by employment title, filter for top 10 titles, pull the titles, and use this as a sorting variable
sort_list <- remuneration %>%
  group_by(employment_title) %>%
  summarise(median_remuneration = median(equivalent_annual_salary, na.rm = T),
            n = n()) %>%
  arrange(desc(median_remuneration)) %>%
  filter(n > 10) %>%
  top_n(n = 10, wt = median_remuneration) %>%
  mutate(employment_title_wrapped = str_wrap(employment_title, width = 10)) %>%
  pull(employment_title)
  
# Filter our remuneration df for the top titles in our sorting list
remuneration <- remuneration %>%
  filter(employment_title %in% sort_list)

# Now create the box plot
ggplot(remuneration, 
       aes(x=reorder(employment_title, equivalent_annual_salary, FUN = median), 
           y=equivalent_annual_salary)) + 
  
  geom_jitter(aes(colour = employment_title), width = 0.3, shape = 21, color = "#002a6c") +
  
  stat_summary(fun = median, show.legend = FALSE, geom = "crossbar", color = "black", width = 0.8) +
  
  scale_y_continuous(labels = label_dollar()) +
  
  coord_flip() + 
  
  labs(x = "Employment Title", y = "Median Annual Remuneration") + 
  
  plot_annotation('Figure 6: Median Annual Remuneration for Top 10 Employment Titles', theme=theme(plot.title=element_text(size=16))) +

  
  scale_fill_manual(values = rep(NA, 2)) +
  
  theme_tq() +
  
  theme(panel.background = element_rect(fill = "white"),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        axis.title.y=element_blank(),
        plot.title = element_text(size = 13),
        text = element_text(size = 16),
        legend.position    = "none")

```

\pagebreak

## Local Partners
In support of USAID’s localization goal, Figure 7 shows how much of USAID’s HRH expenditure is channeled through prime local partners for each primary program area. Note that Local Partners here are defined as local organizations that were awarded as the prime partner, and not as sub-awardees/subrecipients. If a local organization is a subrecipient while the prime partner is an international organization for a given mechanism, then the subrecipient's staffing expenditures will be considered as non-local. While incomplete in terms of the overall localization goal picture, this figure can provide an indication of the level of prime local partner support for HRH in PEPFAR USAID programming.

```{r fig6, fig.height = 5, fig.width = 6, echo = FALSE, eval = TRUE}

# Create the summary df for local partners
local_partner <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, funding_agency, program, is_indigenous_prime_partner, actual_annual_spend) %>%
  mutate(is_indigenous_prime_partner = case_when(is_indigenous_prime_partner == "Y" ~"Yes",
                                                 is_indigenous_prime_partner == "N" ~ "No",
                                                 TRUE ~ is_indigenous_prime_partner)) %>%
  group_by(program, is_indigenous_prime_partner) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T)) %>%
  arrange(desc(actual_annual_spend)) 

# Now plot the summary df
  ggplot(local_partner, aes(x = reorder(program, -actual_annual_spend), 
                          y = actual_annual_spend, 
                          fill = is_indigenous_prime_partner,
                          label = actual_annual_spend)) +
  
  geom_bar(stat = "identity", width = 0.8) +
    
  geom_label_repel(data = local_partner, aes(label = scales::dollar(round(actual_annual_spend))),
             size = 2.5,
             position = position_stack(vjust = 0.5),
             direction = "y",
             show.legend = FALSE) +
  
  xlab("Primary Program Area") +
    
  ylab("Total HRH Expenditure") +
    
  labs(fill = "Prime Local Partner?") +
    
  plot_annotation('Figure 7: Prime Local Partner Support of HRH by Primary Program Area', theme=theme(plot.title=element_text(size=10))) +
    
  scale_y_continuous(labels = label_dollar()) +
    
  scale_fill_manual(values = c("Local" = "#1e87a5",
                              "International" = "#808080")) +

  theme(panel.background = element_rect(fill = "white"),
        axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.title = element_text(size = 10),
        text = element_text(size = 10)) +
  
  theme_tq() 
  
```

\pagebreak

## Work Location
Figure 8 shows the work location of USAID staff by HRH expenditure and individual count. Categories include above site, facility-based, community-based, or roving. Above site staff are defined as personnel that are not directly interacting or providing services to beneficiaries (e.g. technical assistance personnel or support staff based mostly in offices). Roving staff provide direct service delivery in multiple facilities. 

This figure can provide an illustration of the balance of facility and non-facility-based staff. The distribution required in a given PEPFAR-supported country will be determined by program needs. 

```{r fig7, fig.height = 6, fig.width = 8, echo = FALSE, eval = TRUE}

# Create a df that shows HRH expenditure and individual count by work location
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, work_location, actual_annual_spend, individual_count) %>%
  group_by(work_location) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(individual_count)) 

# Make the first plot
g1 <- ggplot(data = patchwork, mapping = aes(x = reorder(work_location, -actual_annual_spend), y = individual_count, fill = work_location)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("Above Site" = "#c43d4d", 
                              "Facility" = "#2057a7",
                              "Community" = "#1e87a5",
                              "Roving" = "#8980cb")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::comma(round(individual_count))),
             size = 4,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
  
    theme_tq() +
  
    labs(title = stringr::str_glue("Individual Count")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 14),
        text = element_text(size = 16)) 

# Make the second plot

g2 <- ggplot(data = patchwork, mapping = aes(x = reorder(work_location, -actual_annual_spend), y = actual_annual_spend, fill = work_location)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("Above Site" = "#c43d4d", 
                              "Facility" = "#2057a7",
                              "Community" = "#1e87a5",
                              "Roving" = "#8980cb")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::dollar(round(actual_annual_spend))),
             size = 4,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
  plot_annotation('Figure 8: HRH Expenditure and Individual Count by Work Location', theme=theme(plot.title=element_text(size=14))) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("HRH Expenditure")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 14),
        text = element_text(size = 16)) 
   
g3 <- g2 + g1

g3

```

\pagebreak

## Top Employment Titles for Community-Based Staff
Figure 9 shows the top five employment titles for community-based staff by count. Moving towards sustainable programming will require comparing PEPFAR-supported employment titles and job functions with local government- and private sector-supported positions/functions and considering pathways to sustainability for the PEPFAR-supported workforce. 

```{r fig8, fig.height = 5, fig.width = 8, echo = FALSE, eval = TRUE}

# Create a df that shows HRH expenditure and individual count by the top 5 community titles
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  filter(is_community_primarily == "Yes") %>%
  select(fiscal_year, work_location, employment_title, actual_annual_spend, individual_count) %>%
  group_by(employment_title) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  top_n(n = 5, wt = individual_count) %>%
  ungroup() %>%
  mutate(employment_title_wrapped = str_wrap(employment_title, width = 10)) %>%
  select(-employment_title)

# Make the column graph
g1 <- patchwork %>%
    ggplot(aes(x = reorder(employment_title_wrapped, individual_count))) +
    geom_col(
        aes(y = individual_count, fill = "Individual Count"),
        alpha = 0.9,
        width = 0.8
    ) +
    geom_label(
        aes(
            y     = individual_count,
            label = scales::comma(round(individual_count)),
            color = "Individual Count",
        ),
        size = 4
    ) +
  
  ylab("Individual Count") + 
  
  theme_tq() +
  
  theme(axis.line=element_blank(),
        axis.ticks=element_blank(),
        plot.title = element_text(size = 10),
        text = element_text(size = 14)) +
  
    scale_color_manual(values = c(
        palette_light()[["blue"]]
    )) +
  
    scale_fill_manual(values = palette_light()[["blue"]]) +
    theme(
        legend.position    = "none",
        axis.title.y=element_blank()
    ) +

    scale_y_continuous(labels = scales::comma_format()) +
  
    coord_flip()

g1 + plot_annotation('Figure 9: Top Five Employment Titles for Community-Based Staff by Individual Count', theme=theme(plot.title=element_text(size=14))) 

```

\pagebreak

## Top Primary Beneficiaries for Community-Based Staff
This shows the top primary beneficiaries supported of community-based staff by individual count

```{r fig9, fig.height = 5, fig.width = 8, echo = FALSE, eval = TRUE}

# Create a df that shows HRH expenditure and individual count by primary beneficiary
patchwork <- HRH_clean %>%
  filter(fiscal_year == 2024) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  filter(work_location == "Community") %>%
  select(fiscal_year, targeted_beneficiary, actual_annual_spend, individual_count) %>%
  mutate(beneficiary_wrapped = str_wrap(targeted_beneficiary, width = 10)) %>%
  group_by(beneficiary_wrapped) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(individual_count)) 

# Make the first plot
g1 <- ggplot(data = patchwork, mapping = aes(x = reorder(beneficiary_wrapped, -actual_annual_spend), y = individual_count, fill = beneficiary_wrapped)) +
    geom_col(alpha = 0.9,
        width = 0.8) +
  
    scale_fill_manual(values = c("Military" = "#c43d4d", 
                              "Key\nPopulations" = "#e07653", 
                              "Children" = "#2057a7",
                              "OVC" = "#1e87a5",
                              "AGYW" = "#f2bc40",
                              "Pregnant & Breastfeeding Women" = "#8980cb",
                              "Non-Targeted\nPopulations" = "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::comma(round(individual_count))),
             size = 3.5,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("Individual Count")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 12),
        text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 


# Make the second plot

g2 <- ggplot(data = patchwork, mapping = aes(x = reorder(beneficiary_wrapped, -actual_annual_spend), y = actual_annual_spend, fill = beneficiary_wrapped)) +
    geom_col(alpha = 0.9,
        width = 0.7) +
  
    scale_fill_manual(values = c("Military" = "#c43d4d", 
                              "Key\nPopulations" = "#e07653", 
                              "Children" = "#2057a7",
                              "OVC" = "#1e87a5",
                              "AGYW" = "#f2bc40",
                              "Pregnant & Breastfeeding Women" = "#8980cb",
                              "Non-Targeted\nPopulations" = "#808080")) +
  
    geom_label_repel(data = patchwork, aes(label = scales::dollar(round(actual_annual_spend))),
             size = 3.5,
             position = "identity",
             min.segment.length = 0.25,
             direction = "y",
             show.legend = FALSE) +
  
    theme_tq() +
  
    labs(title = stringr::str_glue("HRH Expenditure")) +
    theme(axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position    = "none",
        plot.title = element_text(size = 12),
        text = element_text(size = 13),
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) 
   
g3 <- g2 + g1 + plot_annotation('Figure 10: Top Primary Beneficiaries for Community-Based Staff by Individual Count and HRH Expenditure', theme=theme(plot.title=element_text(size=12)))

g3

```

For more detailed analysis of the `r params$fiscal_year` HRH Inventory dataset, please contact the HRH Reporting Help Desk (hrh-reporting-helpdesk@usaid.gov). This may include program-specific deep dives of C&T, DREAMS, OVC, and/or KP mechanisms or reviewing the data using more customized visuals.

