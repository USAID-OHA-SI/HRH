---
title: "FY23 HRH Inventory Summary Report - "
author: "Kyle Borces"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: word_document
params: 
  operating_unit: !r c("Tanzania")
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # supress code
knitr::opts_chunk$set(warning = FALSE, message = FALSE) # suppress all warnings
knitr::opts_chunk$set(dpi=300) # set high resolution of plots

library(plyr)
library(dplyr)
library(tidyverse)
library(sqldf)
library(janitor)
library(readxl)
library(writexl)
library(shiny)
library(scales)
library(tidyquant)
library(formattable)
library(kableExtra)

```

## Automated reports at OU level

This provides a detailed summary of the FY23 HRH Inventory dataset. These reports help summarize staffing investments and trends at the country level to inform current programming, and facilitate HRH planning.

```{r}

# Load the FSD and HRH dataset
fin_data_orig <- read.delim("./1. Data/Financial_Structured_Datasets_COP17-23_20231215.txt") 
load(file = "./4. Outputs/RDS/FY23_cleanHRH.rds") 
load(file = "./4. Outputs/RDS/HRH_ER_merged_21_23.rds") 

```

## Create the first plot using the HRH dataset


```{r, echo = FALSE, eval = TRUE}

# Create the first plot
HRH_reports <- HRH_clean %>%
  filter(fiscal_year == 2023) %>%
  filter(operating_unit == params$operating_unit) %>%
  select(fiscal_year, funding_agency, actual_annual_spend) %>%
  group_by(fiscal_year, funding_agency) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T)) %>%
  arrange(desc(actual_annual_spend))

ggplot(HRH_reports, aes(x = reorder(funding_agency, -actual_annual_spend), y = actual_annual_spend, fill = funding_agency)) +
  geom_bar(stat = "identity", width = 0.6, col = "black", size = 0.3) +
  geom_text(aes(label = paste(round(actual_annual_spend / 1e6, 1), "M"), vjust=-0.5), size = 3) +
  labs(title = stringr::str_glue("Total HRH Expenditure by agency in {params$operating_unit}")) +
  theme(panel.grid = element_blank(), panel.background = element_rect(fill = "white"),
        axis.line=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),legend.position ="none",
        plot.title = element_text(size = 10)) +
  
  scale_fill_manual(values = c("#BA0C2F", "#8C8985", "#002F6C"))

```

## Create a test dual-axis plot

```{r, echo = FALSE, eval = TRUE}

## Create a Transformer Function to be used by the rest of the dual axis plots ----
transformer_dual_y_axis <- function(data,
                                    primary_column, secondary_column,
                                    include_y_zero = FALSE) {

    # PARAMETER SETUP
    params_tbl <- data %>%
        summarise(
            max_primary   = max(!! enquo(primary_column)),
            min_primary   = min(!! enquo(primary_column)),
            max_secondary = max(!! enquo(secondary_column)),
            min_secondary = min(!! enquo(secondary_column))
        )

    if (include_y_zero) {
        params_tbl$min_primary   <- 0
        params_tbl$min_secondary <- 0
    }

    params_tbl <- params_tbl %>%
        mutate(
            scale = (max_secondary - min_secondary) / (max_primary - min_primary),
            shift = min_primary - min_secondary
        )

    # MAKE SCALER FUNCTIONS
    scale_func <- function(x) {
        x * params_tbl$scale - params_tbl$shift
    }

    inv_func <- function(x) {
        (x + params_tbl$shift) / params_tbl$scale
    }

    # RETURN
    ret <- list(
        scale_func = scale_func,
        inv_func   = inv_func,
        params_tbl = params_tbl
    )

    return(ret)
}

```

```{r fig2, fig.height = 5, fig.width = 8, echo = FALSE, eval = TRUE}

# Create a df that shows HRH expenditure and individual count by program area
dual_axis <- HRH_clean %>%
  filter(fiscal_year == 2023) %>%
  filter(funding_agency == "USAID") %>%
  filter(operating_unit == params$operating_unit) %>%
  filter(!program == "Error") %>%
  select(fiscal_year, funding_agency, program, actual_annual_spend, individual_count) %>%
  group_by(program) %>%
  summarise(actual_annual_spend = sum(actual_annual_spend, na.rm = T),
            individual_count = sum(individual_count, na.rm = T)) %>%
  arrange(desc(individual_count)) 

# Create % of total table for inline text later
dual_axis_pct_PM <- dual_axis %>%
  adorn_percentages("col") %>%
  mutate(actual_annual_spend = round(actual_annual_spend * 100),
         individual_count = round(individual_count * 100)) %>%
  filter(program == "PM") %>%
  pull(actual_annual_spend)

# Make A Y-Axis Transformer
transformer <- dual_axis %>%
    transformer_dual_y_axis(
        primary_column   = individual_count,
        secondary_column = actual_annual_spend,
        include_y_zero   = TRUE
    )

# Make the first plot

g1 <- dual_axis %>%
    ggplot(aes(x = reorder(program, -individual_count))) +
    geom_col(
        aes(y = individual_count, fill = "Individual Count"),
        alpha = 0.9
    ) +
    geom_label(
        aes(
            y     = individual_count,
            label = scales::comma(round(individual_count)),
            color = "Individual Count",
        ),
        size = 3
    )

# * 3.2 SECONDARY AXIS ----

g2 <- g1 +
    geom_point(
        aes(y     = transformer$inv_func(actual_annual_spend),
            color = "HRH Expenditure"),
        size = 4
    ) +
    geom_label(
        aes(
            y     = transformer$inv_func(actual_annual_spend),
            label = scales::dollar(round(actual_annual_spend)),
            color = "HRH Expenditure"),
        size = 3,
        nudge_y = 300
    ) + 
  
  
#scale_y_continuous(labels = scales::comma)
    scale_y_continuous(
        name     = "Individual Count",
        labels = scales::comma,
        sec.axis = sec_axis(
            trans = ~ transformer$scale_func(.),
            name  = "Total HRH Expenditure",
            labels = scales::dollar
        )
    ) +
  
  labs(title = stringr::str_glue("Individual Count and HRH Expenditure by Program Area in {params$operating_unit}")) +
  
  theme(panel.grid = element_blank(), panel.background = element_rect(fill = "white"),
        axis.line=element_blank(),
        #axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        plot.title = element_text(size = 10)) 

g3 <- g2 +
    theme_tq() +
    scale_color_manual(values = c(
        palette_light()[["red"]],
        palette_light()[["blue"]]
    )) +
    scale_fill_manual(values = palette_light()[["blue"]]) +
    theme(
        legend.position    = "none",
        axis.title.y.right = element_text(color = palette_light()[["red"]]),
        axis.text.y.right  = element_text(color = palette_light()[["red"]]),
        axis.title.x=element_blank()
    )

g3

```

In `r params$operating_unit`, Program Management comprised about `r dual_axis_pct_PM`% of their total HRH expenditure


## USAID and CDC HRH Inventory Submission Rate
This shows the number of mechanisms that submitted both ER and HRH templates to better understand the overall completeness/reliability of the dataset for `r params$operating_unit`

```{r, echo = FALSE, eval = TRUE}


mech_submissions <- finalMerge %>%
  filter(year == 2023) %>%
  filter(GHSC_UN_keywordflags == "FALSE") %>% # excluding all GHSC and UN mechanisms
  filter(operating_unit == params$operating_unit) %>%
  group_by(year, operating_unit, funding_agency, mech_code) %>%
  summarise(HRH_expenditure_amt = sum(HRH_expenditure_amt, na.rm = T), 
            ER_expenditure_amt = sum(ER_expenditure_amt[HRH_relevant == "Y"], na.rm = T)) %>%
  ungroup() %>%
  group_by(funding_agency) %>%
  summarise(Num_HRH_submissions = length(mech_code[HRH_expenditure_amt > 0]),
            Num_ER_submissions = length(mech_code[ER_expenditure_amt > 0]),
            HRH_expenditure_amt = sum(HRH_expenditure_amt, na.rm = T),
            ER_expenditure_amt = sum(ER_expenditure_amt, na.rm = T)) %>%
  ungroup() %>%
  arrange(desc(HRH_expenditure_amt)) %>%
  adorn_totals() %>%
  mutate(pct_submission_rate = HRH_expenditure_amt / ER_expenditure_amt) %>%
  
  # format the columns
  mutate(across(4:5, formattable::currency,digits=0)) %>%
  mutate(across(6, formattable::percent, digits=0))


knitr::kable(mech_submissions, "simple", 
             col.names=c("Funding Agency", "No. of HRH Submissions", "No. of ER Submissions", 
                         "HRH Expenditure Amount (USD)", "ER Expenditure Amount   (USD", "Overall Submission Rate (%)"),
             caption = "Submission Rate by Agency")

# Create a table that re-creates the content for "Tanzania by the numbers" infographic



# NEXT STEPS: figure out how to export a nicely formatted df to the word doc

```
